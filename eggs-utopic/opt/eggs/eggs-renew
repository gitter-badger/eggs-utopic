#!/bin/bash
######################################################################################
# Eggs: the right contribute to Penguin's diffusion!
#       by Piero Proietti
#
# eggs-renew
#
# Author: Proietti Piero email: piero.proietti@gmail.com
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 2 of the License, or
#  (at your option) any later version.
#  
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#  
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
#  MA 02110-1301, USA.
#  
#
######################################################################################


littlebirdConfigure(){
	# Riconfigurazione littlebird
	# Creazione /etc/hostname
	echo "$CLIENT_HOSTNAME" > /srv/eggs/littlebird/etc/hostname

	# Configuro resolv.conf
	echo "# Generated by eggs " > /srv/eggs/littlebird/etc/resolv.conf
	echo "search localdomain.dom" >> /srv/eggs/littlebird/etc/resolv.conf
	echo "nameserver $CLUSTER_DNS" >> /srv/eggs/littlebird/etc/resolv.conf

	# Configuro  di /etc/resolvconf/resolv.conf.d/base
	echo "### Creazione di /etc/resolvconf/resolv.conf.d/base"
	echo "# Generated by eggs " > /srv/eggs/littlebird/etc/resolvconf/resolv.conf.d/base
	echo "search localdomain.dom" >> /srv/eggs/littlebird/etc/resolvconf/resolv.conf.d/base
	echo "nameserver $CLUSTER_DNS" >>/srv/eggs/littlebird/etc/resolvconf/resolv.conf.d/base

	# Configuro interfaces
	echo "# Generated by eggs " > /srv/eggs/littlebird/etc/network/interfaces
	echo "auto lo" >> /srv/eggs/littlebird/etc/network/interfaces
	echo "iface lo inet loopback" >> /srv/eggs/littlebird/etc/network/interfaces
	echo "iface eth0 inet manual" >> /srv/eggs/littlebird/etc/network/interfaces

	#Creazione di /etc/hosts
	echo "# Generated by eggs " >/srv/eggs/littlebird/etc/hosts
	echo "127.0.0.1 localhost.localdomain localhost $CLIENT_HOSTNAME" >>/srv/eggs/littlebird/etc/hosts
	echo "$IPADDRESS $CLIENT_HOSTNAME.$CLIENTDOMAIN $CLIENT_HOSTNAME " >>/srv/eggs/littlebird/etc/hosts
	echo "" >>/srv/eggs/littlebird/etc/hosts
	echo "# The following lines are desirable for IPv6 capable hosts" >>/srv/eggs/littlebird/etc/hosts
	echo "" >>/srv/eggs/littlebird/etc/hosts
	echo "::1     ip6-localhost ip6-loopback" >>/srv/eggs/littlebird/etc/hosts
	echo "fe00::0 ip6-localnet" >>/srv/eggs/littlebird/etc/hosts
	echo "ff00::0 ip6-mcastprefix" >>/srv/eggs/littlebird/etc/hosts
	echo "ff02::1 ip6-allnodes" >>/srv/eggs/littlebird/etc/hosts
	echo "ff02::2 ip6-allrouters" >>/srv/eggs/littlebird/etc/hosts
	echo "ff02::3 ip6-allhosts" >>/srv/eggs/littlebird/etc/hosts
		

	echo "sshfs root@10.26.106.100:/var/lib/vz/hell/ /home/partimag/"  > /srv/eggs/littlebird/usr/local/bin/connect_to_hell
	chmod 755 /srv/eggs/littlebird/usr/local/bin/connect_to_hell

}


giantTurtleChangeAddress(){
	ifconfig eth0 down
	ifconfig eth0 hw ether $MAC_ADDRESS
	ifconfig eth0 up
	dhclient eth0
}

giantturtleConfigure(){
	# Configurazione pxelinux.cfg
	PXELINUX_CFG=/var/www/html/pxelinux.cfg
	PXELINUX_DEFAULT=$PXELINUX_CFG/default
		
	mkdir -p /var/www/html/pxelinux.cfg
		
	echo "# Generated by eggs " > $PXELINUX_DEFAULT
	echo "DEFAULT vesamenu.c32" >> $PXELINUX_DEFAULT
	echo "TIMEOUT 600" >> $PXELINUX_DEFAULT
	echo "ONTIMEOUT BootLocal" >> $PXELINUX_DEFAULT
	echo "PROMPT 0" >> $PXELINUX_DEFAULT
	echo "KBDMAP it.kbd" >> $PXELINUX_DEFAULT
	echo "DISPLAY display.txt" >> $PXELINUX_DEFAULT
	echo "SAY Uso la tastiera e locale per italiano." >> $PXELINUX_DEFAULT
	echo "MENU TITLE Giant-Turle" >> $PXELINUX_DEFAULT
	echo "MENU BACKGROUND wallpaper.png" >> $PXELINUX_DEFAULT
	echo "" $PXELINUX_DEFAULT
	echo "LABEL little-bird" >> $PXELINUX_DEFAULT
	echo "MENU LABEL little-bird" >> $PXELINUX_DEFAULT
	echo "  KERNEL little-bird/vmlinuz-$KERNEL" >>  $PXELINUX_DEFAULT
	echo "  APPEND root=/dev/nfs initrd=little-bird/initrd.img-$KERNEL nfsroot=$BOOTSERVER_ADDRESS:/srv/eggs/littlebird  ip=dhcp rw" >>  $PXELINUX_DEFAULT
	echo "	IPAPPEND 3" >> $PXELINUX_DEFAULT
	echo "" >> $PXELINUX_DEFAULT
	echo "LABEL ========================================================================" >> $PXELINUX_DEFAULT
	echo "LABEL Avvio da immagini ISO con memdisk - Selezionare l'immagine desiderata" >> $PXELINUX_DEFAULT
	echo "LABEL ========================================================================" >> $PXELINUX_DEFAULT
	echo "LABEL linuxmint-17-mate-dvd-32bit-rc.iso" >> $PXELINUX_DEFAULT
	echo "	MENU LABEL linuxmint-17-mate-dvd-32bit-rc.iso" >> $PXELINUX_DEFAULT
	echo "		LINUX /memdisk" >> $PXELINUX_DEFAULT
	echo "		INITRD /iso/linuxmint-17-mate-dvd-32bit-rc.iso" >> $PXELINUX_DEFAULT
	echo "		APPEND iso" >> $PXELINUX_DEFAULT
	echo "" >> $PXELINUX_DEFAULT
	echo "LABEL ========================================================================" >> $PXELINUX_DEFAULT
	echo "LABEL Boot locale" >> $PXELINUX_DEFAULT
	echo "	localboot 0" >> $PXELINUX_DEFAULT
	echo "	TEXT HELP" >> $PXELINUX_DEFAULT
	echo "	Esegue il boot dal disco locale" >> $PXELINUX_DEFAULT
	echo "	ENDTEXT" >> $PXELINUX_DEFAULT
	echo "" >> $PXELINUX_DEFAULT
	echo "include common.cfg" >> $PXELINUX_DEFAULT
		
	# Configuro dnsmasq.conf
	echo "# Generated by Eggs " >/etc/dnsmasq.conf
	echo "# Disabilito dns" >>/etc/dnsmasq.conf
	echo "port=0" >>/etc/dnsmasq.conf
	echo "# Abilito tftp" >>/etc/dnsmasq.conf
	echo "enable-tftp" >>/etc/dnsmasq.conf
	echo "#Definisco la root per il servizio" >>/etc/dnsmasq.conf
	echo "tftp-root=/var/www/html" >>/etc/dnsmasq.conf
	echo "#Definisco il range proxed" >>/etc/dnsmasq.conf
	echo "dhcp-range=$CLUSTER_NET, proxy , $CLUSTER_NETMASK" >>/etc/dnsmasq.conf
	echo "pxe-prompt = Eggs and penguins, 0" >>/etc/dnsmasq.conf
	echo "# IF dhcp-match=set:ipxe,175 THEN" >>/etc/dnsmasq.conf
	echo "	dhcp-match=set:ipxe,175 # iPXE sends a 175 option." >>/etc/dnsmasq.conf
	echo "		dhcp-boot=tag:!ipxe,undionly.kpxe" >>/etc/dnsmasq.conf
	echo "#ELSE" >>/etc/dnsmasq.conf
	echo "		dhcp-boot=http://$BOOTSERVER_ADDRESS/lpxelinux.0" >>/etc/dnsmasq.conf
	echo "# ENDIF" >>/etc/dnsmasq.conf

}

bootServerStart()
{
		service portmap stop
		/etc/init.d/nfs-kernel-server stop
		service portmap start
		/etc/init.d/nfs-kernel-server start
		exportfs -rv

		/etc/init.d/dnsmasq restart
		
		echo "Il sistema Ã¨ stato configurato con i seguenti parametri:"
		echo "- Rete servita: $CLUSTER_NET/$CLUSTER_NETMASK"
		echo "- Boot server"
		echo "  - ip address: $BOOTSERVER_ADDRESS"
		echo "  - netmask:    $CLUSTER_NETMASK"
		echo "  - gateway:    $CLUSTER_GATEWAY"
		echo "  - mac address $MAC_ADDRESS"
		echo "  - Name server DNS: $CLUSTER_DNS"

		echo "Adesso puoi avviare qualsiasi pc dalla rete..."
}


##########################################################################################################################
# RILEVAZIONE DELLE VARIABILI PRINCIPALI
##########################################################################################################################
clear
echo "Penguin\'s Eggs riconfigurazione. Attendere prego... "

# 00:60:1d: Lucent
declare MAC_ADDRESS=00:60:1d:`(date; cat /proc/interrupts) | md5sum | sed -r 's/^(.{6}).*$/\1/; s/([0-9a-f]{2})/\1:/g; s/:$//;'`

giantTurtleChangeAddress

declare BOOTSERVER_ADDRESS=$(ifconfig eth0 | grep inet | grep -v inet6 | cut -d ":" -f 2 | cut -d " " -f 1)
declare CLUSTER_BROADCAST=$(ifconfig eth0 | grep inet | grep -v inet6 | cut -d ":" -f 3 | cut -d " " -f 1)
declare CLUSTER_NET1=$(ifconfig eth0 | grep inet | grep -v inet6 | cut -d ":" -f 2 | cut -d " " -f 1| cut -d "." -f1 )
declare CLUSTER_NET2=$(ifconfig eth0 | grep inet | grep -v inet6 | cut -d ":" -f 2 | cut -d " " -f 1| cut -d "." -f2 )
declare CLUSTER_NET3=$(ifconfig eth0 | grep inet | grep -v inet6 | cut -d ":" -f 2 | cut -d " " -f 1| cut -d "." -f3 )
declare CLUSTER_NET="$CLUSTER_NET1.$CLUSTER_NET2.$CLUSTER_NET3.0"
declare CLUSTER_NETMASK=$(ifconfig eth0 | grep inet | grep -v inet6 | cut -d ":" -f 4 | cut -d " " -f 1)

declare DEFAULTGROUPS="audio,cdrom,dialout,floppy,video,plugdev"

declare CLUSTER_DNS=$(nm-tool | grep DNS | cut -d ":" -f2 |sed 's/^ *//g')
declare CLUSTER_GATEWAY=$(nm-tool | grep Gateway | cut -d ":" -f2 |sed 's/^ *//g')
declare CLIENT_USERNAME=$(users)
declare CLIENT_HOSTNAME=$(cat /srv/eggs/littlebird/etc/hostname)
declare KERNEL=$(uname -r)

########################################################################
# main
########################################################################

littlebirdConfigure
giantturtleConfigure
bootServerStart
